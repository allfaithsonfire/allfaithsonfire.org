<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>All Faiths On Fire</title>
  <style>
    * { box-sizing: border-box; }
    html, body {
      margin: 0;
      padding: 0;
      font-family: sans-serif;
      height: 100%;
      overflow: hidden;
    }
    header, footer {
      background: #222;
      color: #fff;
      padding: 1rem;
      text-align: center;
    }
    .layout {
      display: flex;
      flex-direction: column;
      height: 100vh;
    }
    .main {
      display: flex;
      flex: 1;
      min-height: 0;
    }
    nav.toc, aside.right {
      min-width: 240px;
      width: clamp(260px, 20vw, 360px);
      width: 240px;
      background: #f4f4f4;
      padding: 1rem;
      overflow-y: auto;
    }
    main.content {
      flex: 1;
      overflow-y: auto;
      padding: 2rem;
    }
    .inner-content {
      max-width: 60ch;
      margin: 0 auto;
    }
    .toc h2, .right h2 { margin-top: 0; }
    .book-toggle {
      cursor: pointer;
      font-weight: bold;
      margin-top: 1rem;
      user-select: none;
    }
    .chapter-list {
      margin-left: 1rem;
      display: none;
    }
    .chapter-link {
      display: block;
      text-decoration: none;
      color: #444;
      margin: 0.25rem 0;
    }
    .chapter {
      margin-bottom: 2rem;
    }
    .chapter p {
      margin-bottom: 1em;
      line-height: 1.5;
    }
    .chapter p strong {
      display: inline-block;
      width: 2ch;
    }
    footer {
      padding: 0.5rem;
      font-size: 0.9em;
    }
  </style>
  <link rel="stylesheet" href="/css/themes.css">
</head>
<body>
  <div class="layout">
    <header>
      <h1>All Faiths On Fire - A Ministry of Good Works</h1>
      <div><em><%= quote.quote %></em></div>
    </header>
    <div class="main">
      <nav class="toc">
        <h2>Table of Contents</h2>


        <% books.forEach(book => { %>
          <div class="book-wrapper">
            <div class="book-toggle" data-target="book-<%= book.id %>">
              <%= book.title %>
            </div>
            <div class="chapter-list" id="book-<%= book.id %>">
              <% book.chapters.forEach(ch => { %>
                <a href="/?chapter=<%= ch.filename %>" class="chapter-link"><%= ch.title %></a>
              <% }) %>
            </div>
          </div>
        <% }) %>
      
    <div style="margin-top:2rem;text-align:center;">
      <button onclick="goChapter('prev')">‚Üê</button>
      <button onclick="goChapter('next')">‚Üí</button>
    </div>
  </nav>
      <main class="content">
        <div class="inner-content">
          <% if (chapter) { %>
            <div class="chapter">
              <h2><%= chapter.title %></h2>
              <% verses.forEach(v => { %>
                <p><strong><%= v.verse_number %></strong> <%= v.text %></p>
              <% }) %>
            </div>
          <% } else { %>
            <p style="text-align:center;">Select a chapter from the Table of Contents to begin.</p>
          <% } %>
        </div>
      </main>
      <aside class="right">
        <h2>Mission</h2>
        <p>To awaken the dreamers, the burden-bearers, and the kind. To write the Book as it should have been written. Together.</p>
        <ul>
          <li><a href="/about">About</a></li>
          <li><a href="/creed">Creed</a></li>
          <li><a href="/submit">Submit/Edit</a></li>
          <li><a href="https://discord.gg/allfaithsonfire" target="_blank">Discord</a></li>
          <li><a href="https://gofundme.com/allfaithsonfire" target="_blank">GoFundMe</a></li>
        </ul>
      </aside>
    </div>
    <footer>
      &copy; All Faiths On Fire - <%= new Date().getFullYear() %>
    </footer>
  </div>
<div id="theme-toggle" style="position:fixed;bottom:20px;right:20px;z-index:1000;">
  <button style="font-size: 1.5rem; padding: 0.6rem 1rem;" onclick="toggleThemeMenu()">‚òº</button>
  <div id="theme-menu" style="display:none;position:absolute;bottom:50px;right:0;background:#222;color:#fff;padding:0.75rem;border-radius:0.5rem;width:180px;">
    <button onclick="setTheme('light')" style="width:100%;margin-bottom:4px;">‚òÄÔ∏è Light</button>
    <button onclick="setTheme('dark')" style="width:100%;margin-bottom:4px;">üåë Dark</button>
    <button onclick="setTheme('warm')" style="width:100%;margin-bottom:4px;">üî• Warm</button>
    <button onclick="setTheme('cool')" style="width:100%;">‚ùÑÔ∏è Cool</button>
    <div style="margin-top:8px;">
      <label><input type="checkbox" id="twoColToggle" onchange="toggleColumns()"> 2 Columns</label>
    </div>
  </div>
</div>
<script>
function toggleThemeMenu() {
  const menu = document.getElementById('theme-menu');
  menu.style.display = menu.style.display === 'none' ? 'block' : 'none';
}
function setTheme(name) {
  document.body.className = name;
  document.cookie = "theme=" + name + "; path=/";
}
function toggleColumns() {
  const main = document.querySelector('.inner-content');
  const twoCol = document.getElementById('twoColToggle').checked;
  main.style.columnCount = twoCol ? 2 : 1;
  document.cookie = "twocol=" + (twoCol ? "yes" : "no") + "; path=/";
}
function getCookie(key) {
  const val = document.cookie.split('; ').find(row => row.startsWith(key + "="));
  return val ? val.split('=')[1] : null;
}
function openBookForChapter(filename) {
  const link = document.querySelector(`.chapter-link[href*="${filename}"]`);
  if (!link) return;
  const parent = link.closest('.chapter-list');
  if (parent) parent.classList.add('open');
}
function activateTocToggles() {
  document.querySelectorAll('.book-toggle').forEach(toggle => {
    toggle.addEventListener('click', e => {
      const targetId = toggle.dataset.target;
      const content = document.getElementById(targetId);
      if (content) {
        content.classList.toggle('open');
      }
      e.stopPropagation();
    });
  });
}
async function loadChapter(filename, push = true) {
  const res = await fetch('/chapter/' + filename);
  const html = await res.text();
  document.querySelector('.inner-content').innerHTML = html;
  if (push) history.pushState({ chapter: filename }, '', '?chapter=' + filename);
  openBookForChapter(filename);
  activateTocToggles();
}
window.onpopstate = (e) => {
  const chap = e.state?.chapter;
  if (chap) loadChapter(chap, false);
};
window.onload = () => {
  const theme = getCookie("theme");
  if (theme) setTheme(theme);
  const col = getCookie("twocol");
  if (col === "yes") {
    document.getElementById('twoColToggle').checked = true;
    toggleColumns();
  }
  const chapterParam = new URLSearchParams(window.location.search).get("chapter");
  if (chapterParam) loadChapter(chapterParam, false);
  document.querySelectorAll('.chapter-link').forEach(link => {
    link.addEventListener('click', e => {
      e.preventDefault();
      const filename = new URL(link.href).searchParams.get('chapter');
      if (filename) loadChapter(filename);
      e.stopPropagation();
    });
  });
  activateTocToggles();
};
function goChapter(direction) {
  const chapters = [...document.querySelectorAll('.chapter-link')];
  const current = window.location.href.split('chapter=')[1];
  let index = chapters.findIndex(link => link.href.includes(current));
  if (index === -1) index = 0;
  const next = direction === 'next' ? chapters[index + 1] : chapters[index - 1];
  if (next) {
    const filename = new URL(next.href).searchParams.get('chapter');
    if (filename) loadChapter(filename);
  }
}
</script>
</body>
</html>
